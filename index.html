<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ArcGIS OAuth Selector</title>
</head>
<body>
  <h2>Select a Client</h2>
  <select id="clientSelector">
    <option value="">-- Choose a client --</option>
    <option value="Dealmap|kJb5xoqjKAHsY2ag|https://urbanize.maps.arcgis.com/apps/webappviewer/index.html?id=f6354f9fc1024799bc92dde2a0f10ae4">DealMap</option>
    <option value="Georgia 2024|rfNcWeqHUfLt8kA9|https://urbtx.maps.arcgis.com/apps/webappviewer/index.html?id=09dbef59d03c47a28337e56a3125052a">Georgia 2024</option>
    <option value="South Carolina 2025|rfNcWeqHUfLt8kA9|https://urbtx.maps.arcgis.com/apps/webappviewer/index.html?id=d67f996ede5744b388116b3bcf137fdf">2025 South Carolina LIHTC Map</option>
    <option value="Virginia 2025|rfNcWeqHUfLt8kA9|https://urbtx.maps.arcgis.com/apps/webappviewer/index.html?id=2f36456652274acab7f570f016913b6c">2024 Virginia LIHTC Map - Doran Co</option>
  </select>

<script>
  const redirectUri = "https://urbanizedev.github.io/arcgis_github_oauth/";

  function handleAuthFlow(clientId, baseDestinationUrl) {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const token = params.get("access_token");

    if (token) {
      sessionStorage.removeItem("selectedClient"); // Clean up
      window.location.href = `${baseDestinationUrl}&token=${token}`;
      return;
    }

    const authUrl = new URL("https://www.arcgis.com/sharing/rest/oauth2/authorize");
    authUrl.searchParams.set("client_id", clientId);
    authUrl.searchParams.set("response_type", "token");
    authUrl.searchParams.set("redirect_uri", redirectUri);
    authUrl.searchParams.set("expiration", "20160");

    window.location.href = authUrl.toString();
  }

  const selector = document.getElementById("clientSelector");

  selector.addEventListener("change", function () {
    const selection = this.value;
    if (!selection) return;

    sessionStorage.setItem("selectedClient", selection); // Save selection

    const [label, clientId, baseDestinationUrl] = selection.split("|");
    handleAuthFlow(clientId, baseDestinationUrl);
  });

  window.addEventListener("DOMContentLoaded", () => {
    const stored = sessionStorage.getItem("selectedClient");
    if (stored) {
      const [label, clientId, baseDestinationUrl] = stored.split("|");
      handleAuthFlow(clientId, baseDestinationUrl);
    }
  });
</script>
</body>
</html>
